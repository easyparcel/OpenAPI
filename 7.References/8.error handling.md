# EasyParcel API Error Handling Guide

This document outlines the common error patterns and recommended handling strategies when working with the EasyParcel API.

## Error Response Patterns

The EasyParcel API returns specific error formats depending on the type of error encountered. Understanding these patterns will help you implement proper error handling in your integration.

## Authentication Errors

When authentication fails, you'll receive a response in this format:

```json
{
    "error": {
        "statusCode": 401,
        "status": 401,
        "code": 401,
        "name": "invalid_token"
    },
    "status_code": 401
}
```

### Common Authentication Error Codes

| Error Name       | Description                                         | Recommended Action                                  |
|------------------|-----------------------------------------------------|-----------------------------------------------------|
| invalid_token    | The API key is invalid or expired                   | Verify your API key and request a new one if needed |
| missing_token    | No API key was provided in the request              | Ensure API key is included in the request header    |
| insufficient_scope| The API key doesn't have permission for this action | Request appropriate permissions for your API key    |

## Validation Errors

### Single Resource Validation

For single resource operations with validation errors:

```json
{
    "status_code": 400,
    "message": "Validation error",
    "data": {
        "errors": [
            "The service id field is required",
            "The collection date field is required"
        ]
    }
}
```

### Batch Operation Errors

For batch operations, the API may return a mix of successful and failed operations:

#### Complete Batch Failure

```json
{
    "status_code": 200,
    "message": "0 requests success, 3 request error.",
    "data": [
        {
            "order_details": {
                "account_id": "438671"
            },
            "pricing": {
                "currency_code": "MYR",
                "total_amount": "0.00",
                "total_tax_amount": "0.00"
            },
            "shipments": [
                {
                    "status": "error",
                    /* shipment details */
                    "errors": [
                        "The service id field is required",
                        "The collection date field is required",
                        "The receiver phone number country code field is required",
                        "The receiver phone number field is required",
                        "The receiver address 1 field is required"
                    ]
                },
                /* additional failed shipments */
            ]
        }
    ]
}
```

#### Partial Success in Batch Operations

```json
{
    "status_code": 200,
    "message": "1 request success, 1 request error.",
    "data": [
        {
            "order_details": {
                "order_number": "EI-2504-6WFXC",
                "account_id": 438671
            },
            "pricing": {
                "currency_code": "MYR",
                "total_amount": "27.83",
                "total_tax_amount": "1.63"
            },
            "shipments": [
                {
                    "status": "success",
                    /* successful shipment details */
                },
                {
                    "status": "error",
                    /* failed shipment details */
                    "errors": [
                        "The service id field is required",
                        "The collection date field is required"
                    ]
                }
            ]
        }
    ]
}
```

## Quotation Errors

Quotation endpoints also follow the batch processing pattern, where some items may succeed while others fail:

```json
{
    "status_code": 200,
    "message": "1 request success, 2 request error.",
    "data": [
        {
            "status": "success",
            "input": { /* input details */ },
            "quotations": [ /* quotation results */ ]
        },
        {
            "status": "error",
            "input": { /* input details */ },
            "errors": [
                "The receiver postcode is invalid"
            ]
        },
        {
            "status": "error",
            "input": { /* input details */ },
            "errors": [
                "The receiver country field is required"
            ]
        }
    ]
}
```

## Common Error Messages

Here are some common error messages you may encounter and how to resolve them:

### Request Validation Errors

| Error Message                                  | Possible Cause                              | Resolution                                            |
|------------------------------------------------|---------------------------------------------|-------------------------------------------------------|
| "The service id field is required"             | Missing service_id in request               | Include a valid service_id from courier list          |
| "The collection date field is required"        | Missing or invalid collection_date          | Provide a valid date in YYYY-MM-DD format            |
| "The receiver phone number field is required"  | Missing receiver phone number               | Include the receiver's phone number                   |
| "The receiver address 1 field is required"     | Missing primary address line                | Include the first line of the receiver's address      |
| "The receiver postcode is invalid"             | Invalid or non-existent postal code         | Verify the postal code with the courier service       |
| "The receiver country field is required"       | Missing country code                        | Include a valid country code (e.g., "MY" for Malaysia)|

### Business Logic Errors

| Error Message                                  | Possible Cause                              | Resolution                                            |
|------------------------------------------------|---------------------------------------------|-------------------------------------------------------|
| "Shipment Already Cancelled"                   | Attempting to cancel an already cancelled shipment | Check shipment status before cancellation request    |
| "No Order with shipment_number X found"        | Incorrect shipment number or not owned by account | Verify the shipment number belongs to your account   |
| "Shipment Cannot Be Cancelled"                 | Shipment is in a state that can't be cancelled | Only shipments in certain states can be cancelled    |
| "Weight exceeds service limits"                | Parcel exceeds courier weight restrictions  | Choose a different service or reduce parcel weight    |
| "Service not available for origin/destination" | Route not serviced by selected courier      | Choose a different courier service                    |

## Error Handling Best Practices

### 1. Check Status Code and Message

Always check both the `status_code` and `message` fields to properly identify errors. A 200 status code does not always mean complete success in batch operations.

### 2. Handle Batch Operations Carefully

For batch operations:
- Parse the `message` field to determine success/error counts
- Iterate through each item in the data array
- Check the `status` field of each item
- Process successful items and handle errors for failed items

### 3. Implement Retry Logic

For transient errors (e.g., network issues, temporary service unavailability), implement a retry mechanism with exponential backoff.

### 4. Log Detailed Error Information

Log detailed error information for troubleshooting, including:
- Request parameters
- Complete error response
- Timestamp
- API endpoint

### 5. Handle Validation Errors Proactively

Implement client-side validation based on known API requirements to reduce validation errors.

### 6. Check for Partial Success

Always assume batch operations may partially succeed and handle accordingly:

```javascript
// Example handling of a batch response
function handleBatchResponse(response) {
  console.log(`Processing response: ${response.message}`);
  
  if (response.status_code !== 200) {
    return handleNonSuccessStatusCode(response);
  }
  
  // Extract success/failure counts from message
  const messageParts = response.message.split(',');
  const successCount = parseInt(messageParts[0].match(/\d+/)[0]);
  const errorCount = parseInt(messageParts[1].match(/\d+/)[0]);
  
  console.log(`Shipments: ${successCount} successful, ${errorCount} failed`);
  
  // Process data
  response.data.forEach(order => {
    if (order.shipments) {
      order.shipments.forEach(shipment => {
        if (shipment.status === 'success') {
          processSuccessfulShipment(shipment);
        } else {
          handleFailedShipment(shipment);
        }
      });
    }
  });
}
```

## Authentication Error Recovery

If you encounter authentication errors:

1. Verify your API key is correct
2. Check if your API key has expired
3. Request a new API key if necessary
4. Ensure your system securely stores the API key
5. Implement automatic token refresh if supported

## Common HTTP Status Codes

| Status Code | Description                 | Handling Strategy                                    |
|-------------|-----------------------------|------------------------------------------------------|
| 200         | Success (may include errors)| Check message and individual item status             |
| 400         | Bad Request                 | Fix request parameters based on error details        |
| 401         | Unauthorized                | Refresh or update API credentials                    |
| 403         | Forbidden                   | Request appropriate permissions                      |
| 404         | Not Found                   | Verify resource identifiers                          |
| 429         | Too Many Requests           | Implement rate limiting and backoff strategy         |
| 500         | Server Error                | Retry with exponential backoff                       |

## Troubleshooting Guide

### API Key Issues
- Ensure API key is not expired
- Verify API key is correctly included in the authorization header
- Check if your account has the necessary permissions

### Invalid Input
- Validate all required fields are present
- Ensure postal codes are valid for the respective countries
- Verify dimensions and weights are within courier limitations

### Service Availability
- Check if selected service is available for the specific route
- Verify the courier is operational on the requested collection date
- Confirm service availability for international routes

### Shipment Status Issues
- Verify shipment status before attempting to modify or cancel
- Check if the shipment number exists and belongs to your account
- Ensure operations are performed within allowed timeframes (e.g., cancellation window)

## Contact Support

If you encounter persistent errors that cannot be resolved through this guide, contact EasyParcel support with the following information:

1. Complete request and response details
2. Timestamp of the request
3. API endpoint used
4. Description of the expected vs. actual behavior
5. Steps taken to troubleshoot the issue
<div align="center" style="margin: 1.5rem 0;">

[![Back to official documents](https://img.shields.io/badge/Back_to_official_documents-007ACC?style=flat-square)](../README.md)
[![←Previous Section](https://img.shields.io/badge/Previous_Section_%E2%86%90-FF7733?style=flat-square)](/6.Webhook/1.Guide%20to%20subscribe%20webhook.md)
[![←Previous Paragraph](https://img.shields.io/badge/Previous_Paragraph_%E2%86%90-FF7733?style=flat-square)](/7.References/7.request%20&%20status%20code.md)
[![Next Paragraph →](https://img.shields.io/badge/Next_Paragraph_%E2%86%92-00CC88?style=flat-square)](/7.References/9.pagination.md)

</div>
